//@version=5
strategy("ET-Cup and Handle v2", overlay=true, initial_capital=10000, margin_long=100, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// 使用者參數
txtNote        = input.string("", "備註（僅供記錄）")
cupLen         = input.int(50, "杯深偵測週期", minval=10)
handleLen      = input.int(20, "柄深偵測週期", minval=5)
stopLossPct    = input.float(3.0, "停損百分比 (%)", step=0.1)
takeProfitPct  = input.float(6.0, "停利百分比 (%)", step=0.1)

// 新增文字輸入欄位
enterLongKey  = input.string("ENTER-LONG_miS7M06is7DPHOE52xAoO3hlKwI=", "Enter Long") //ENTER-LONG_miS7M06is7DPHOE52xAoO3hlKwI=
exitLongKey   = input.string("EXIT-LONG_miS7M06is7DPHOE52xAoO3hlKwI=", "Exit Long") //EXIT-LONG_miS7M06is7DPHOE52xAoO3hlKwI=
// TradingView Msg: {{strategy.order.comment}}

// 回測日期範圍
fromDate       = input.time(defval=1577836800000, title="回測開始日期")  // 2020-01-01
toDate         = input.time(defval=1767225540000, title="回測結束日期")  // 2025-12-31
inDateRange    = (time >= fromDate) and (time <= toDate)

// 偵測杯底與杯頂 pivots
pivotLowIdx    = ta.pivotlow(low,  cupLen,  cupLen)
pivotHighIdx   = ta.pivothigh(high, cupLen, cupLen)

var float cupBottomPrice = na
var float cupTopPrice    = na
if not na(pivotLowIdx)
    cupBottomPrice := low[pivotLowIdx]
if not na(pivotHighIdx)
    cupTopPrice    := high[pivotHighIdx]

// 計算頸線
neckline = cupTopPrice

// 偵測柄低點
handleLowIdx    = ta.pivotlow(low,  handleLen, handleLen)
var float handleLowPrice = na
if not na(handleLowIdx)
    handleLowPrice := low[handleLowIdx]

// 計算深度與過濾條件
cupDepth      = cupTopPrice - cupBottomPrice
isCupValid    = not na(cupBottomPrice) and not na(cupTopPrice) and cupDepth <= neckline * 0.3
isHandleValid = not na(handleLowPrice) and (neckline - handleLowPrice) <= cupDepth * 0.5
isBreakout    = ta.cross(close, neckline)

// 進出場信號
var float stopLevel   = na
var float profitLevel = na
if isCupValid and isHandleValid and isBreakout and inDateRange
    stopLevel   := close * (1 - stopLossPct  / 100)
    profitLevel := close * (1 + takeProfitPct / 100)
    strategy.entry("Long", strategy.long, comment = enterLongKey)
    strategy.exit("Exit", from_entry="Long", stop=stopLevel, limit=profitLevel, comment = exitLongKey)

// 可視化繪製：
// 1. 繪製杯頂、杯底、柄低線
plot(cupTopPrice,    title="杯頂價格", color=color.red,    style=plot.style_linebr, linewidth=3)
plot(cupBottomPrice, title="杯底價格", color=color.yellow,  style=plot.style_linebr, linewidth=3)
plot(handleLowPrice, title="柄低價格", color=color.green,   style=plot.style_linebr, linewidth=3)

// 2. 以文字標籤取代原本的圖形標記（單行參數）
if not na(pivotLowIdx)
    label.new(x=bar_index[pivotLowIdx], y=low[pivotLowIdx],   text="杯底", style=label.style_label_up,   color=color.green,  textcolor=color.black, size=size.tiny)
if not na(pivotHighIdx)
    label.new(x=bar_index[pivotHighIdx],y=high[pivotHighIdx], text="杯頂", style=label.style_label_down, color=color.red,    textcolor=color.black, size=size.tiny)
if not na(handleLowIdx)
    label.new(x=bar_index[handleLowIdx],y=low[handleLowIdx],  text="柄底", style=label.style_label_up,   color=color.orange, textcolor=color.black, size=size.tiny)

// 3. 繪製停損與停利線
plot(stopLevel,  title="停損水平", color=color.red,   style=plot.style_line, linewidth=1)
plot(profitLevel,title="停利水平", color=color.green, style=plot.style_line, linewidth=1)


// NA 標示：當關鍵價格為 na 時，在圖表頂部顯示灰色 NA
if na(cupBottomPrice)
    label.new(bar_index, high, text="NA", style=label.style_label_down, color=color.gray, textcolor=color.white, size=size.tiny)
if na(cupTopPrice)
    label.new(bar_index, high, text="NA", style=label.style_label_down, color=color.gray, textcolor=color.white, size=size.tiny)
if na(handleLowPrice)
    label.new(bar_index, high, text="NA", style=label.style_label_down, color=color.gray, textcolor=color.white, size=size.tiny)

// 建議：
// - 可自訂標籤文字、樣式與大小
// - 可加入成交量或多條均線作進一步篩選
// - 若需調整回測期間與參數，請透過上方設定面板修改
